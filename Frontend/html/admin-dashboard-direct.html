<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Leave Management System</title>
  <link rel="stylesheet" href="../css/admin-dashboard.css">
  <style>
    /* Additional professional styling for direct access */
    .direct-access-notice {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      padding: var(--spacing-lg);
      margin: var(--spacing-xl) 0;
      border-radius: var(--radius-lg);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    
    .direct-access-notice strong {
      color: #d97706;
      font-size: var(--font-size-lg);
    }
    
    .login-section {
      background: var(--white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-xl);
      margin: var(--spacing-xl) 0;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }
    
    .login-section h3 {
      color: var(--gray-800);
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-xl);
      font-weight: 700;
      text-align: center;
    }
    
    .login-form {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: var(--spacing-lg);
    }
    
    .login-form input {
      padding: var(--spacing-md);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      min-width: 200px;
      transition: all 0.2s ease;
    }
    
    .login-form input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .login-form button {
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-weight: 600;
      font-size: var(--font-size-base);
      transition: all 0.2s ease;
      min-width: 120px;
      box-shadow: var(--shadow-sm);
    }
    
    .login-form button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .credentials-info {
      background: var(--gray-50);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
      text-align: center;
    }
    
    .credentials-info strong {
      color: var(--gray-700);
      display: block;
      margin-bottom: var(--spacing-sm);
      font-size: var(--font-size-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .credentials-info code {
      background: var(--gray-200);
      color: var(--gray-800);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: var(--font-size-sm);
    }
    
    .credentials-info p {
      margin: var(--spacing-sm) 0;
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      line-height: 1.5;
    }
    
    /* Loading state */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--gray-300);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Enhanced responsive design */
    @media (max-width: 768px) {
      .login-form {
        flex-direction: column;
        align-items: stretch;
      }
      
      .login-form input,
      .login-form button {
        width: 100%;
        min-width: auto;
      }
      
      .credentials-info {
        padding: var(--spacing-md);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ Admin Dashboard - Leave Management</h1>
      <div class="user-info">
        <span id="currentUser">Not logged in</span>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </div>
    </header>

    <div class="login-section" id="loginSection">
      <h3>üîê Quick Admin Login</h3>
      <div class="login-form">
        <input type="text" id="quickUsername" placeholder="Username" value="admin.user">
        <input type="password" id="quickPassword" placeholder="Password" value="password123">
        <button onclick="quickLogin()" id="loginBtn">
          <span id="loginBtnText">Login</span>
          <span id="loginBtnLoading" class="loading" style="display: none;"></span>
        </button>
      </div>
      <div class="credentials-info">
        <strong>Admin Credentials</strong>
        <p>
          Username: <code>admin.user</code> | Password: <code>password123</code><br>
          Username: <code>manager.user</code> | Password: <code>password123</code>
        </p>
      </div>
    </div>

    <nav class="admin-nav" id="adminNav" style="display: none;">
      <button class="nav-btn active" onclick="showSection('pending')">üìã Pending Applications</button>
      <button class="nav-btn" onclick="showSection('all')">üìä All Applications</button>
      <button class="nav-btn" onclick="showSection('stats')">üìà Statistics</button>
    </nav>

    <main id="mainContent" style="display: none;">
      <!-- Pending Applications Section -->
      <section id="pending-section" class="section active">
        <h2>‚è≥ Pending Leave Applications</h2>
        <div class="applications-container">
          <div id="pending-applications" class="applications-list">
            <!-- Pending applications will be loaded here -->
          </div>
        </div>
      </section>

      <!-- All Applications Section -->
      <section id="all-section" class="section">
        <h2>üìã All Leave Applications</h2>
        <div class="applications-container">
          <div id="all-applications" class="applications-list">
            <!-- All applications will be loaded here -->
          </div>
        </div>
      </section>

      <!-- Statistics Section -->
      <section id="stats-section" class="section">
        <h2>üìä Leave Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Applications</h3>
            <p id="total-applications">0</p>
          </div>
          <div class="stat-card">
            <h3>Pending</h3>
            <p id="pending-count">0</p>
          </div>
          <div class="stat-card">
            <h3>Approved</h3>
            <p id="approved-count">0</p>
          </div>
          <div class="stat-card">
            <h3>Rejected</h3>
            <p id="rejected-count">0</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal for approving/rejecting leave -->
  <div id="action-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modal-title">üéØ Update Leave Application</h2>
      <form id="action-form">
        <input type="hidden" id="application-id">
        <div class="form-group">
          <label for="action-status">Action:</label>
          <select id="action-status" required>
            <option value="">Select action</option>
            <option value="Approved">‚úÖ Approve</option>
            <option value="Rejected">‚ùå Reject</option>
          </select>
        </div>
        <div class="form-group">
          <label for="action-remarks">Remarks:</label>
          <textarea id="action-remarks" rows="3" placeholder="Enter remarks (optional)"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Submit Decision</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global variables
    let currentUser = null;
    let allApplications = [];
    let pendingApplications = [];

    // Quick login function
    async function quickLogin() {
      const username = document.getElementById('quickUsername').value;
      const password = document.getElementById('quickPassword').value;
      
      if (!username || !password) {
        showError('Please enter both username and password');
        return;
      }

      // Show loading state
      const loginBtn = document.getElementById('loginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const loginBtnLoading = document.getElementById('loginBtnLoading');
      
      loginBtn.disabled = true;
      loginBtnText.style.display = 'none';
      loginBtnLoading.style.display = 'inline-block';

      try {
        const response = await fetch('http://localhost:3000/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password })
        });

        const result = await response.json();

        if (response.ok) {
          // Store user information including role
          const userInfo = {
            username: username,
            role: result.role || 'employee',
            department: result.department,
            designation: result.designation
          };
          localStorage.setItem('currentUser', JSON.stringify(userInfo));
          
          currentUser = userInfo;
          
          // Check if user has admin or manager role
          if (userInfo.role !== 'admin' && userInfo.role !== 'manager') {
            showError('Access denied. Admin or Manager role required.');
            return;
          }
          
          // Hide login section and show admin interface
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminNav').style.display = 'block';
          document.getElementById('mainContent').style.display = 'block';
          
          // Update user info display
          document.getElementById('currentUser').textContent = `${userInfo.username} (${userInfo.role})`;
          
          // Load initial data
          await loadPendingApplications();
          await loadAllApplications();
          updateStatistics();
          
          showSuccess('Login successful! Welcome to Admin Dashboard.');
          
        } else {
          showError(result.message || 'Login failed. Please check your credentials.');
        }
      } catch (error) {
        console.error('Login error:', error);
        showError('Network error. Please check if the server is running and try again.');
      } finally {
        // Reset loading state
        loginBtn.disabled = false;
        loginBtnText.style.display = 'inline';
        loginBtnLoading.style.display = 'none';
      }
    }

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
      // Modal close button
      document.querySelector('.close').addEventListener('click', closeModal);
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('action-modal')) {
          closeModal();
        }
      });
      
      // Form submission
      document.getElementById('action-form').addEventListener('submit', handleStatusUpdate);
    }

    // Navigation between sections
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(`${sectionName}-section`).classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
    }

    // Load pending applications
    async function loadPendingApplications() {
      try {
        const response = await fetch(`http://localhost:3000/api/leave/admin/pending?username=${currentUser.username}`);
        if (!response.ok) {
          throw new Error('Failed to fetch pending applications');
        }
        
        pendingApplications = await response.json();
        displayPendingApplications();
      } catch (error) {
        console.error('Error loading pending applications:', error);
        showError('Failed to load pending applications');
      }
    }

    // Load all applications
    async function loadAllApplications() {
      try {
        const response = await fetch(`http://localhost:3000/api/leave/admin/all?username=${currentUser.username}`);
        if (!response.ok) {
          throw new Error('Failed to fetch all applications');
        }
        
        allApplications = await response.json();
        displayAllApplications();
        updateStatistics();
      } catch (error) {
        console.error('Error loading all applications:', error);
        showError('Failed to load all applications');
      }
    }

    // Display pending applications
    function displayPendingApplications() {
      const container = document.getElementById('pending-applications');
      
      if (pendingApplications.length === 0) {
        container.innerHTML = '<p class="no-applications">üéâ No pending applications to review!</p>';
        return;
      }
      
      container.innerHTML = pendingApplications.map(app => createApplicationCard(app, true)).join('');
    }

    // Display all applications
    function displayAllApplications() {
      const container = document.getElementById('all-applications');
      
      if (allApplications.length === 0) {
        container.innerHTML = '<p class="no-applications">üìù No applications found</p>';
        return;
      }
      
      container.innerHTML = allApplications.map(app => createApplicationCard(app, false)).join('');
    }

    // Create application card HTML
    function createApplicationCard(application, showActions = true) {
      const statusClass = `status-${application.status.toLowerCase()}`;
      const statusText = application.status;
      
      let actionsHTML = '';
      if (showActions && application.status === 'Pending') {
        actionsHTML = `
          <div class="application-actions">
            <button class="btn btn-success" onclick="openActionModal('${application.id}', 'approve')">
              ‚úÖ Approve
            </button>
            <button class="btn btn-danger" onclick="openActionModal('${application.id}', 'reject')">
              ‚ùå Reject
            </button>
          </div>
        `;
      } else if (application.status !== 'Pending') {
        actionsHTML = `
          <div class="application-actions">
            <span class="detail-label">Approved by: ${application.approvedBy || 'N/A'}</span>
            <span class="detail-label">Date: ${application.approvedDate ? new Date(application.approvedDate).toLocaleDateString() : 'N/A'}</span>
          </div>
        `;
      }
      
      return `
        <div class="application-card">
          <div class="application-header">
            <span class="application-id">#${application.id}</span>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          <div class="application-details">
            <div class="detail-item">
              <span class="detail-label">Employee</span>
              <span class="detail-value">${application.username}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Leave Type</span>
              <span class="detail-value">${application.leaveType}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">From Date</span>
              <span class="detail-value">${new Date(application.fromDate).toLocaleDateString()}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">To Date</span>
              <span class="detail-value">${new Date(application.toDate).toLocaleDateString()}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Reason</span>
              <span class="detail-value">${application.reason}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Applied Date</span>
              <span class="detail-value">${new Date(application.appliedDate).toLocaleDateString()}</span>
            </div>
            ${application.remarks ? `
              <div class="detail-item">
                <span class="detail-label">Remarks</span>
                <span class="detail-value">${application.remarks}</span>
              </div>
            ` : ''}
          </div>
          ${actionsHTML}
        </div>
      `;
    }

    // Open action modal for approve/reject
    function openActionModal(applicationId, action) {
      const modal = document.getElementById('action-modal');
      const statusSelect = document.getElementById('action-status');
      const applicationIdInput = document.getElementById('application-id');
      
      applicationIdInput.value = applicationId;
      
      if (action === 'approve') {
        statusSelect.value = 'Approved';
      } else if (action === 'reject') {
        statusSelect.value = 'Rejected';
      }
      
      modal.style.display = 'block';
    }

    // Close modal
    function closeModal() {
      document.getElementById('action-modal').style.display = 'none';
      document.getElementById('action-form').reset();
    }

    // Handle status update form submission
    async function handleStatusUpdate(event) {
      event.preventDefault();
      
      const applicationId = document.getElementById('application-id').value;
      const status = document.getElementById('action-status').value;
      const remarks = document.getElementById('action-remarks').value;
      
      if (!status) {
        showError('Please select an action');
        return;
      }
      
      try {
        const response = await fetch('http://localhost:3000/api/leave/admin/update-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUser.username,
            applicationId: applicationId,
            status: status,
            remarks: remarks
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to update application status');
        }
        
        const result = await response.json();
        showSuccess('Leave application status updated successfully');
        
        // Set flag to notify dashboard of update
        localStorage.setItem('lastAdminUpdate', Date.now().toString());
        
        // Close modal and refresh data
        closeModal();
        await loadPendingApplications();
        await loadAllApplications();
        
      } catch (error) {
        console.error('Error updating application status:', error);
        showError('Failed to update application status');
      }
    }

    // Update statistics
    function updateStatistics() {
      const total = allApplications.length;
      const pending = allApplications.filter(app => app.status === 'Pending').length;
      const approved = allApplications.filter(app => app.status === 'Approved').length;
      const rejected = allApplications.filter(app => app.status === 'Rejected').length;
      
      document.getElementById('total-applications').textContent = total;
      document.getElementById('pending-count').textContent = pending;
      document.getElementById('approved-count').textContent = approved;
      document.getElementById('rejected-count').textContent = rejected;
    }

    // Show success message
    function showSuccess(message) {
      // Create a professional toast notification
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Show error message
    function showError(message) {
      // Create a professional error toast notification
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--danger-color);
        color: white;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 4000);
    }

    // Logout function
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      
      // Show login section and hide admin interface
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('adminNav').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
      
      // Reset user info display
      document.getElementById('currentUser').textContent = 'Not logged in';
      
      // Clear data
      allApplications = [];
      pendingApplications = [];
    }

    // Add CSS animations for toast notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
